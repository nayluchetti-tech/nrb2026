<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PRAY.COM Booth | Audio Lead Capture</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0B0C0D;
      color: #FFFFFF;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
    }

    /* ===== HEADER ===== */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      background: rgba(11,12,13,0.95);
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .app-logo {
      font-size: 18px;
      font-weight: 900;
      letter-spacing: 0.04em;
    }
    .app-logo sub {
      font-size: 9px;
      font-weight: 600;
      color: #E3AF4A;
      vertical-align: baseline;
      position: relative;
      top: -1px;
      margin-left: 2px;
    }
    .app-badge {
      font-size: 11px;
      font-weight: 700;
      color: #E3AF4A;
      background: rgba(227,175,74,0.1);
      border: 1px solid rgba(227,175,74,0.25);
      padding: 4px 12px;
      border-radius: 16px;
    }

    /* ===== MAIN ===== */
    .app-main {
      max-width: 600px;
      margin: 0 auto;
      padding: 24px 20px 100px;
    }

    /* ===== AE SELECTOR ===== */
    .ae-section {
      margin-bottom: 28px;
    }
    .ae-section label {
      display: block;
      font-size: 12px;
      font-weight: 700;
      color: rgba(255,255,255,0.5);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 8px;
    }
    .ae-select {
      width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 15px;
      color: #FFFFFF;
      font-family: inherit;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23E3AF4A' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      padding-right: 40px;
      cursor: pointer;
    }
    .ae-select:focus {
      outline: none;
      border-color: #E3AF4A;
      box-shadow: 0 0 0 3px rgba(227,175,74,0.1);
    }
    .ae-select option {
      background: #1a1b1e;
      color: #FFFFFF;
    }

    /* ===== RECORDING AREA ===== */
    .record-section {
      text-align: center;
      margin-bottom: 32px;
    }
    .record-instruction {
      font-size: 14px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 24px;
      line-height: 1.6;
    }
    .record-instruction strong { color: rgba(255,255,255,0.8); }

    .record-btn {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 3px solid rgba(227,175,74,0.3);
      background: rgba(227,175,74,0.08);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      position: relative;
    }
    .record-btn:hover {
      border-color: rgba(227,175,74,0.6);
      background: rgba(227,175,74,0.12);
    }
    .record-btn.recording {
      border-color: #e74c3c;
      background: rgba(231,76,60,0.1);
      animation: pulse-record 1.5s ease-in-out infinite;
    }
    @keyframes pulse-record {
      0%, 100% { box-shadow: 0 0 0 0 rgba(231,76,60,0.3); }
      50% { box-shadow: 0 0 0 20px rgba(231,76,60,0); }
    }

    .mic-icon {
      width: 40px;
      height: 40px;
    }
    .mic-icon svg { width: 100%; height: 100%; }
    .record-btn.recording .mic-icon svg path { fill: #e74c3c; }

    .record-status {
      margin-top: 16px;
      font-size: 14px;
      font-weight: 600;
    }
    .status-ready { color: rgba(255,255,255,0.4); }
    .status-recording { color: #e74c3c; }
    .status-processing { color: #E3AF4A; }
    .status-done { color: #4CAF50; }

    .record-timer {
      font-size: 28px;
      font-weight: 800;
      font-variant-numeric: tabular-nums;
      color: rgba(255,255,255,0.3);
      margin-top: 8px;
    }
    .record-btn.recording ~ .record-timer { color: #e74c3c; }

    /* ===== PROMPT GUIDE ===== */
    .prompt-guide {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 28px;
    }
    .prompt-guide h3 {
      font-size: 13px;
      font-weight: 700;
      color: #E3AF4A;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 12px;
    }
    .prompt-list {
      list-style: none;
    }
    .prompt-list li {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      font-size: 13px;
      color: rgba(255,255,255,0.65);
      line-height: 1.5;
    }
    .prompt-num {
      flex-shrink: 0;
      width: 22px;
      height: 22px;
      background: rgba(227,175,74,0.1);
      color: #E3AF4A;
      font-size: 11px;
      font-weight: 700;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ===== TRANSCRIPT DISPLAY ===== */
    .transcript-section {
      display: none;
      margin-bottom: 28px;
    }
    .transcript-section.visible { display: block; }
    .transcript-label {
      font-size: 12px;
      font-weight: 700;
      color: rgba(255,255,255,0.5);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 10px;
    }
    .transcript-box {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 16px;
      font-size: 14px;
      color: rgba(255,255,255,0.7);
      line-height: 1.7;
      min-height: 80px;
      max-height: 200px;
      overflow-y: auto;
    }

    /* ===== STRUCTURED DATA ===== */
    .structured-section {
      display: none;
      margin-bottom: 28px;
    }
    .structured-section.visible { display: block; }
    .structured-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 24px;
    }
    .structured-card h3 {
      font-size: 16px;
      font-weight: 800;
      margin-bottom: 16px;
    }
    .field-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .field-item {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 10px;
      padding: 12px 14px;
    }
    .field-item.full-width {
      grid-column: 1 / -1;
    }
    .field-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #E3AF4A;
      margin-bottom: 4px;
    }
    .field-value {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }
    .field-value input,
    .field-value select,
    .field-value textarea {
      width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 14px;
      color: #FFFFFF;
      font-family: inherit;
    }
    .field-value input:focus,
    .field-value select:focus,
    .field-value textarea:focus {
      outline: none;
      border-color: #E3AF4A;
    }
    .field-value textarea {
      resize: vertical;
      min-height: 60px;
    }
    .field-value select {
      appearance: none;
      -webkit-appearance: none;
      cursor: pointer;
    }
    .field-value select option {
      background: #1a1b1e;
      color: #FFFFFF;
    }

    /* ===== MEETING RATING ===== */
    .rating-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .rating-label {
      font-size: 13px;
      font-weight: 700;
      color: rgba(255,255,255,0.7);
      margin-bottom: 10px;
    }
    .rating-stars {
      display: flex;
      gap: 8px;
    }
    .star-btn {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.3);
      font-size: 18px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .star-btn:hover {
      border-color: rgba(227,175,74,0.3);
      background: rgba(227,175,74,0.08);
      color: #E3AF4A;
    }
    .star-btn.active {
      border-color: #E3AF4A;
      background: rgba(227,175,74,0.15);
      color: #E3AF4A;
    }

    /* ===== SUBMIT BUTTON ===== */
    .submit-section {
      display: none;
    }
    .submit-section.visible { display: block; }
    .submit-btn {
      width: 100%;
      background: #E3AF4A;
      color: #0B0C0D;
      font-size: 16px;
      font-weight: 700;
      padding: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .submit-btn:hover { background: #D4982E; transform: translateY(-1px); }
    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .submit-note {
      text-align: center;
      font-size: 12px;
      color: rgba(255,255,255,0.3);
      margin-top: 10px;
    }

    /* ===== SUCCESS STATE ===== */
    .success-state {
      display: none;
      text-align: center;
      padding: 40px 20px;
    }
    .success-state.visible { display: block; }
    .success-check {
      width: 72px;
      height: 72px;
      background: rgba(76,175,80,0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 32px;
      color: #4CAF50;
    }
    .success-state h2 {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 8px;
    }
    .success-state p {
      font-size: 14px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 24px;
    }
    .new-capture-btn {
      display: inline-block;
      background: rgba(227,175,74,0.12);
      color: #E3AF4A;
      font-size: 14px;
      font-weight: 700;
      padding: 14px 28px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .new-capture-btn:hover {
      background: #E3AF4A;
      color: #0B0C0D;
    }

    /* ===== RECENT CAPTURES ===== */
    .recent-section {
      margin-top: 40px;
      padding-top: 28px;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .recent-section h3 {
      font-size: 14px;
      font-weight: 700;
      color: rgba(255,255,255,0.5);
      margin-bottom: 16px;
    }
    .recent-list { list-style: none; }
    .recent-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 16px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: 10px;
      margin-bottom: 8px;
    }
    .recent-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(227,175,74,0.1);
      color: #E3AF4A;
      font-size: 13px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .recent-info { flex: 1; }
    .recent-name { font-size: 14px; font-weight: 600; }
    .recent-company { font-size: 12px; color: rgba(255,255,255,0.4); }
    .recent-time {
      font-size: 11px;
      color: rgba(255,255,255,0.3);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 600px) {
      .field-grid { grid-template-columns: 1fr; }
      .record-btn { width: 100px; height: 100px; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="app-header">
    <div class="app-logo">PRAY.COM<sub>BOOTH</sub></div>
    <span class="app-badge">Audio Lead Capture</span>
  </header>

  <main class="app-main">
    <!-- AE Selector -->
    <div class="ae-section">
      <label for="aeSelect">Your Name (AE)</label>
      <select id="aeSelect" class="ae-select">
        <option value="" disabled selected>Select your name</option>
        <option value="ae_1">AE 1</option>
        <option value="ae_2">AE 2</option>
        <option value="ae_3">AE 3</option>
        <option value="ae_4">AE 4</option>
        <option value="ae_5">AE 5</option>
        <option value="booth_manager">Booth Manager</option>
      </select>
    </div>

    <!-- Recording Prompt -->
    <div class="prompt-guide">
      <h3>What to Say in Your Recording</h3>
      <ul class="prompt-list">
        <li><span class="prompt-num">1</span><span><strong>Person's name and title</strong> &mdash; "I just spoke with John Smith, he's the Senior Pastor at..."</span></li>
        <li><span class="prompt-num">2</span><span><strong>Company/Ministry name</strong> &mdash; "...Grace Community Church..."</span></li>
        <li><span class="prompt-num">3</span><span><strong>What you discussed</strong> &mdash; "He was very interested in SuperFunnel and asked about pricing..."</span></li>
        <li><span class="prompt-num">4</span><span><strong>Their pain points/goals</strong> &mdash; "They're struggling with donor acquisition and want to grow their media presence..."</span></li>
        <li><span class="prompt-num">5</span><span><strong>Next steps agreed</strong> &mdash; "He wants a follow-up demo next week. I told him I'd send the ROI calculator..."</span></li>
        <li><span class="prompt-num">6</span><span><strong>Your gut feeling</strong> &mdash; "This is a hot lead, I'd rate it a 4 out of 5..."</span></li>
      </ul>
    </div>

    <!-- Record Button -->
    <div class="record-section" id="recordSection">
      <p class="record-instruction">
        Tap to <strong>start recording</strong>. Tap again to <strong>stop</strong>.<br>
        Speak naturally. The AI will extract and structure the data.
      </p>
      <button class="record-btn" id="recordBtn" type="button">
        <span class="mic-icon">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 1C10.34 1 9 2.34 9 4V12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12V4C15 2.34 13.66 1 12 1Z" fill="#E3AF4A"/>
            <path d="M17 12C17 14.76 14.76 17 12 17C9.24 17 7 14.76 7 12H5C5 15.53 7.61 18.43 11 18.93V22H13V18.93C16.39 18.43 19 15.53 19 12H17Z" fill="#E3AF4A"/>
          </svg>
        </span>
      </button>
      <p class="record-status status-ready" id="recordStatus">Tap to Record</p>
      <p class="record-timer" id="recordTimer">0:00</p>
    </div>

    <!-- Transcript -->
    <div class="transcript-section" id="transcriptSection">
      <p class="transcript-label">Transcript</p>
      <div class="transcript-box" id="transcriptBox"></div>
    </div>

    <!-- Structured Data Form -->
    <div class="structured-section" id="structuredSection">
      <div class="structured-card">
        <h3>Extracted Lead Data</h3>
        <p style="font-size: 13px; color: rgba(255,255,255,0.4); margin-bottom: 20px;">Review and correct the AI-extracted fields below before submitting to HubSpot.</p>

        <div class="field-grid">
          <div class="field-item">
            <div class="field-label">First Name</div>
            <div class="field-value"><input type="text" id="leadFirstName" placeholder="John"></div>
          </div>
          <div class="field-item">
            <div class="field-label">Last Name</div>
            <div class="field-value"><input type="text" id="leadLastName" placeholder="Smith"></div>
          </div>
          <div class="field-item">
            <div class="field-label">Title / Role</div>
            <div class="field-value"><input type="text" id="leadTitle" placeholder="Senior Pastor"></div>
          </div>
          <div class="field-item">
            <div class="field-label">Company / Ministry</div>
            <div class="field-value"><input type="text" id="leadCompany" placeholder="Grace Community Church"></div>
          </div>
          <div class="field-item">
            <div class="field-label">Email (if mentioned)</div>
            <div class="field-value"><input type="email" id="leadEmail" placeholder="john@church.org"></div>
          </div>
          <div class="field-item">
            <div class="field-label">Phone (if mentioned)</div>
            <div class="field-value"><input type="tel" id="leadPhone" placeholder="(555) 123-4567"></div>
          </div>
          <div class="field-item">
            <div class="field-label">Products Discussed</div>
            <div class="field-value">
              <select id="leadProducts">
                <option value="" disabled selected>Select product</option>
                <option value="superfunnel">SuperFunnel</option>
                <option value="pray_studio">PRAY Studio</option>
                <option value="reach">Reach</option>
                <option value="america_prays">America Prays 250</option>
                <option value="full_platform">Full Platform</option>
                <option value="general">General Discussion</option>
              </select>
            </div>
          </div>
          <div class="field-item">
            <div class="field-label">Demo Given?</div>
            <div class="field-value">
              <select id="leadDemo">
                <option value="" disabled selected>Select</option>
                <option value="yes">Yes - full demo</option>
                <option value="partial">Partial demo</option>
                <option value="no">No demo</option>
              </select>
            </div>
          </div>
          <div class="field-item full-width">
            <div class="field-label">Conversation Summary</div>
            <div class="field-value"><textarea id="leadSummary" rows="3" placeholder="Key points from the conversation..."></textarea></div>
          </div>
          <div class="field-item full-width">
            <div class="field-label">Pain Points / Goals</div>
            <div class="field-value"><textarea id="leadPainPoints" rows="2" placeholder="What they're struggling with or trying to achieve..."></textarea></div>
          </div>
          <div class="field-item full-width">
            <div class="field-label">Next Steps Agreed</div>
            <div class="field-value"><textarea id="leadNextSteps" rows="2" placeholder="Follow-up actions discussed..."></textarea></div>
          </div>
        </div>

        <!-- Meeting Quality Rating -->
        <div class="rating-section">
          <p class="rating-label">Meeting Quality (Deal Potential)</p>
          <div class="rating-stars" id="ratingStars">
            <button class="star-btn" data-rating="1" type="button">1</button>
            <button class="star-btn" data-rating="2" type="button">2</button>
            <button class="star-btn" data-rating="3" type="button">3</button>
            <button class="star-btn" data-rating="4" type="button">4</button>
            <button class="star-btn" data-rating="5" type="button">5</button>
          </div>
          <p style="font-size: 11px; color: rgba(255,255,255,0.3); margin-top: 8px;">1 = Long shot &nbsp;|&nbsp; 3 = Warm opportunity &nbsp;|&nbsp; 5 = Ready to close</p>
        </div>
      </div>
    </div>

    <!-- Submit -->
    <div class="submit-section" id="submitSection">
      <button class="submit-btn" id="submitBtn" type="button">Send to HubSpot</button>
      <p class="submit-note">Data will be created/updated as a contact in HubSpot with all NRB properties.</p>
    </div>

    <!-- Success -->
    <div class="success-state" id="successState">
      <div class="success-check">&#10003;</div>
      <h2>Lead Captured!</h2>
      <p>Contact has been sent to HubSpot with all NRB 2026 properties. The follow-up sequence will be triggered automatically.</p>
      <button class="new-capture-btn" id="newCaptureBtn" type="button">Capture Next Lead</button>
    </div>

    <!-- Recent Captures -->
    <div class="recent-section" id="recentSection">
      <h3>Recent Captures (This Session)</h3>
      <ul class="recent-list" id="recentList"></ul>
    </div>
  </main>

  <script>
    // =============================================
    // AUDIO RECORDING + SPEECH RECOGNITION
    // =============================================
    var isRecording = false;
    var mediaRecorder = null;
    var audioChunks = [];
    var timerInterval = null;
    var seconds = 0;
    var recognition = null;
    var transcript = '';
    var currentRating = 0;
    var recentCaptures = [];

    var recordBtn = document.getElementById('recordBtn');
    var recordStatus = document.getElementById('recordStatus');
    var recordTimer = document.getElementById('recordTimer');
    var transcriptSection = document.getElementById('transcriptSection');
    var transcriptBox = document.getElementById('transcriptBox');
    var structuredSection = document.getElementById('structuredSection');
    var submitSection = document.getElementById('submitSection');
    var successState = document.getElementById('successState');

    // Initialize Speech Recognition
    function initSpeechRecognition() {
      var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        console.warn('Speech Recognition not supported in this browser.');
        return null;
      }
      var recog = new SpeechRecognition();
      recog.continuous = true;
      recog.interimResults = true;
      recog.lang = 'en-US';

      recog.onresult = function(event) {
        var interimTranscript = '';
        var finalTranscript = '';
        for (var i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript + ' ';
          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }
        if (finalTranscript) {
          transcript += finalTranscript;
        }
        transcriptBox.textContent = transcript + interimTranscript;
        transcriptSection.classList.add('visible');
      };

      recog.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        if (event.error === 'no-speech') {
          // Restart if still recording
          if (isRecording) {
            try { recog.start(); } catch(e) {}
          }
        }
      };

      recog.onend = function() {
        if (isRecording) {
          try { recog.start(); } catch(e) {}
        }
      };

      return recog;
    }

    // Timer functions
    function startTimer() {
      seconds = 0;
      updateTimerDisplay();
      timerInterval = setInterval(function() {
        seconds++;
        updateTimerDisplay();
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
    }

    function updateTimerDisplay() {
      var mins = Math.floor(seconds / 60);
      var secs = seconds % 60;
      recordTimer.textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
    }

    // Record button handler
    recordBtn.addEventListener('click', function() {
      if (!isRecording) {
        startRecording();
      } else {
        stopRecording();
      }
    });

    function startRecording() {
      // Check AE selection
      if (!document.getElementById('aeSelect').value) {
        document.getElementById('aeSelect').style.borderColor = '#e74c3c';
        document.getElementById('aeSelect').focus();
        return;
      }
      document.getElementById('aeSelect').style.borderColor = 'rgba(255,255,255,0.1)';

      isRecording = true;
      transcript = '';
      transcriptBox.textContent = '';

      recordBtn.classList.add('recording');
      recordStatus.textContent = 'Recording...';
      recordStatus.className = 'record-status status-recording';
      startTimer();

      // Start speech recognition
      recognition = initSpeechRecognition();
      if (recognition) {
        try {
          recognition.start();
        } catch(e) {
          console.error('Failed to start speech recognition:', e);
        }
      }

      // Start audio recording for backup
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(function(stream) {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = function(e) {
              audioChunks.push(e.data);
            };
            mediaRecorder.start();
          })
          .catch(function(err) {
            console.error('Microphone access denied:', err);
          });
      }
    }

    function stopRecording() {
      isRecording = false;
      recordBtn.classList.remove('recording');
      recordStatus.textContent = 'Processing...';
      recordStatus.className = 'record-status status-processing';
      stopTimer();

      // Stop speech recognition
      if (recognition) {
        recognition.stop();
      }

      // Stop audio recording
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(function(t) { t.stop(); });
      }

      // Process transcript and show structured form
      setTimeout(function() {
        processTranscript();
        recordStatus.textContent = 'Recording complete';
        recordStatus.className = 'record-status status-done';
      }, 500);
    }

    // =============================================
    // TRANSCRIPT PROCESSING (AI-powered extraction)
    // =============================================
    function processTranscript() {
      var text = transcript.toLowerCase();

      // Simple keyword extraction (in production, this would call Claude API)
      // Extract name patterns
      var nameMatch = text.match(/(?:spoke with|talked to|met|name is|this is)\s+([a-z]+)\s+([a-z]+)/i);
      if (nameMatch) {
        document.getElementById('leadFirstName').value = capitalize(nameMatch[1]);
        document.getElementById('leadLastName').value = capitalize(nameMatch[2]);
      }

      // Extract title
      var titles = ['senior pastor', 'executive pastor', 'pastor', 'ceo', 'founder', 'president', 'director', 'vp', 'vice president', 'media director', 'marketing director', 'executive director', 'campus pastor'];
      for (var i = 0; i < titles.length; i++) {
        if (text.indexOf(titles[i]) !== -1) {
          document.getElementById('leadTitle').value = capitalizeWords(titles[i]);
          break;
        }
      }

      // Extract company
      var companyMatch = text.match(/(?:at|from|with|church|ministry|organization)\s+([a-z\s]+?)(?:\.|,|he|she|they|was|is|and)/i);
      if (companyMatch) {
        document.getElementById('leadCompany').value = capitalizeWords(companyMatch[1].trim());
      }

      // Detect products
      if (text.indexOf('superfunnel') !== -1 || text.indexOf('super funnel') !== -1 || text.indexOf('donor') !== -1) {
        document.getElementById('leadProducts').value = 'superfunnel';
      } else if (text.indexOf('studio') !== -1 || text.indexOf('ai') !== -1 || text.indexOf('content') !== -1) {
        document.getElementById('leadProducts').value = 'pray_studio';
      } else if (text.indexOf('reach') !== -1 || text.indexOf('distribution') !== -1) {
        document.getElementById('leadProducts').value = 'reach';
      } else if (text.indexOf('america prays') !== -1 || text.indexOf('white house') !== -1) {
        document.getElementById('leadProducts').value = 'america_prays';
      }

      // Detect demo
      if (text.indexOf('demo') !== -1 || text.indexOf('showed') !== -1 || text.indexOf('walked through') !== -1) {
        document.getElementById('leadDemo').value = 'yes';
      }

      // Set conversation summary as the full transcript
      document.getElementById('leadSummary').value = transcript.trim();

      // Show the structured form
      structuredSection.classList.add('visible');
      submitSection.classList.add('visible');
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function capitalizeWords(str) {
      return str.replace(/\b\w/g, function(c) { return c.toUpperCase(); });
    }

    // =============================================
    // RATING STARS
    // =============================================
    document.getElementById('ratingStars').addEventListener('click', function(e) {
      var btn = e.target.closest('.star-btn');
      if (!btn) return;
      currentRating = parseInt(btn.dataset.rating);
      document.querySelectorAll('.star-btn').forEach(function(s) {
        s.classList.toggle('active', parseInt(s.dataset.rating) <= currentRating);
      });
    });

    // =============================================
    // SUBMIT TO HUBSPOT
    // =============================================
    document.getElementById('submitBtn').addEventListener('click', function() {
      var btn = this;
      btn.disabled = true;
      btn.textContent = 'Sending...';

      var leadData = {
        ae_owner: document.getElementById('aeSelect').value,
        first_name: document.getElementById('leadFirstName').value,
        last_name: document.getElementById('leadLastName').value,
        title: document.getElementById('leadTitle').value,
        company: document.getElementById('leadCompany').value,
        email: document.getElementById('leadEmail').value,
        phone: document.getElementById('leadPhone').value,
        products_discussed: document.getElementById('leadProducts').value,
        demo_given: document.getElementById('leadDemo').value,
        conversation_summary: document.getElementById('leadSummary').value,
        pain_points: document.getElementById('leadPainPoints').value,
        next_steps: document.getElementById('leadNextSteps').value,
        meeting_quality: currentRating,
        full_transcript: transcript,
        // HubSpot properties
        lead_source: 'nrb_2026',
        nrb_capture_method: 'audio_note',
        nrb_intent_level: 'high',
        nrb_scenario: 'demo_conversation',
        nrb_conversation: true,
        capture_timestamp: new Date().toISOString()
      };

      console.log('=== HUBSPOT LEAD DATA ===');
      console.log(JSON.stringify(leadData, null, 2));

      // In production, this would POST to HubSpot API:
      // POST https://api.hubapi.com/crm/v3/objects/contacts
      // with properties mapped from leadData

      // Simulate API call
      setTimeout(function() {
        // Add to recent captures
        recentCaptures.unshift({
          name: leadData.first_name + ' ' + leadData.last_name,
          company: leadData.company,
          time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
          rating: currentRating
        });
        updateRecentList();

        // Show success
        document.getElementById('recordSection').style.display = 'none';
        transcriptSection.classList.remove('visible');
        structuredSection.classList.remove('visible');
        submitSection.classList.remove('visible');
        successState.classList.add('visible');
      }, 1000);
    });

    // =============================================
    // NEW CAPTURE / RESET
    // =============================================
    document.getElementById('newCaptureBtn').addEventListener('click', function() {
      // Reset everything
      transcript = '';
      currentRating = 0;
      seconds = 0;

      transcriptBox.textContent = '';
      document.getElementById('leadFirstName').value = '';
      document.getElementById('leadLastName').value = '';
      document.getElementById('leadTitle').value = '';
      document.getElementById('leadCompany').value = '';
      document.getElementById('leadEmail').value = '';
      document.getElementById('leadPhone').value = '';
      document.getElementById('leadProducts').selectedIndex = 0;
      document.getElementById('leadDemo').selectedIndex = 0;
      document.getElementById('leadSummary').value = '';
      document.getElementById('leadPainPoints').value = '';
      document.getElementById('leadNextSteps').value = '';
      document.querySelectorAll('.star-btn').forEach(function(s) { s.classList.remove('active'); });

      recordStatus.textContent = 'Tap to Record';
      recordStatus.className = 'record-status status-ready';
      recordTimer.textContent = '0:00';

      var submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Send to HubSpot';

      // Show/hide sections
      document.getElementById('recordSection').style.display = '';
      transcriptSection.classList.remove('visible');
      structuredSection.classList.remove('visible');
      submitSection.classList.remove('visible');
      successState.classList.remove('visible');
    });

    // =============================================
    // RECENT CAPTURES LIST
    // =============================================
    function updateRecentList() {
      var list = document.getElementById('recentList');
      list.innerHTML = '';
      recentCaptures.forEach(function(capture) {
        var initials = (capture.name.split(' ').map(function(n) { return n[0]; }).join('') || '?').toUpperCase();
        var li = document.createElement('li');
        li.className = 'recent-item';
        li.innerHTML = '<div class="recent-avatar">' + initials + '</div>' +
          '<div class="recent-info"><div class="recent-name">' + capture.name + '</div>' +
          '<div class="recent-company">' + (capture.company || 'Unknown company') + ' &bull; Rating: ' + (capture.rating || '-') + '/5</div></div>' +
          '<span class="recent-time">' + capture.time + '</span>';
        list.appendChild(li);
      });

      if (recentCaptures.length > 0) {
        document.getElementById('recentSection').style.display = '';
      }
    }

    // Hide recent section if empty
    if (recentCaptures.length === 0) {
      document.getElementById('recentSection').style.display = 'none';
    }
  </script>

</body>
</html>
